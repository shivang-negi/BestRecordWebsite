<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Best Record</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <style>
    /* Import Google font */
    @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Open Sans', sans-serif;
    }

    body {
      height: 100vh;
      width: 100vw;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      background-color: #282828;
    }

    .wrapper {
      margin: 5%;
      width: 65vmin;
      height: 70vmin;
      display: flex;
      overflow: hidden;
      flex-direction: column;
      justify-content: center;
      border-radius: 5px;
      background: #293447;
      box-shadow: 0 20px 40px #141414;
    }

    .second {
      margin: 5%;
    }

    .game-details {
      color: #B8C6DC;
      font-weight: 500;
      font-size: 1.2rem;
      padding: 20px 27px;
      display: flex;
      justify-content: space-between;
    }

    .play-board {
      height: 100%;
      width: 100%;
      display: grid;
      background: #212837;
      grid-template: repeat(30, 1fr) / repeat(30, 1fr);
    }

    .play-board .food {
      background: #FF003D;
    }

    .play-board .head {
      background: #60CBFF;
    }

    .controls {
      display: none;
      justify-content: space-between;
    }

    .controls i {
      padding: 25px 0;
      text-align: center;
      font-size: 1.3rem;
      color: #B8C6DC;
      width: calc(100% / 4);
      cursor: pointer;
      border-right: 1px solid #171B26;
    }

    @media screen and (max-width: 800px) {
      .wrapper {
        width: 90vmin;
        height: 115vmin;
      }

      .game-details {
        font-size: 1rem;
        padding: 15px 27px;
      }

      .controls {
        display: flex;
      }

      .controls i {
        padding: 15px 0;
        font-size: 1rem;
      }
    }

    .second {
      display: flex;
      flex-direction: column;
    }

    .Scoreboard {
      margin-top: 15%;
      border: 2px solid #ddd;
      width: max-content;
    }

    thead {
      text-align: center;
    }

    caption {
      caption-side: top;
      text-align: center;
      color: white;
      font-size: 1.8em;
      font-weight: bold;
      font-family: 'Courier New', Courier, monospace;
    }

    td,
    th {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      color: #ddd;
    }

    .item {
      color: #3f516f;
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Pragma" content="no-cache">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
</head>

<body>
  <div class="wrapper">
    <div class="game-details">
      <span class="score">Score: 0</span>
      <span class="high-score"></span>
    </div>
    <div class="play-board"></div>
    <div class="controls">
      <i data-key="ArrowLeft" class="fa-solid fa-arrow-left-long"></i>
      <i data-key="ArrowUp" class="fa-solid fa-arrow-up-long"></i>
      <i data-key="ArrowRight" class="fa-solid fa-arrow-right-long"></i>
      <i data-key="ArrowDown" class="fa-solid fa-arrow-down-long"></i>
    </div>
  </div>
  <div class="second">
    <div class="buttons">
      <button class="btn btn-light btnfld" onclick="retry()">Retry</button>
      <button class="btn btn-light btnfld" onclick="logout()">Logout</button>
    </div>
    <div class="Scoreboard">
      <table>
        <caption>Scoreboard</caption>
        <tr>
          <th>Rank</th>
          <th>Username</th>
          <th>Score</th>
        </tr>
        <tr>
          <td class="first">
            <img
              src="https://firebasestorage.googleapis.com/v0/b/healthcaremanagement-8fa5f.appspot.com/o/images%2Ffirst.png?alt=media&token=acaec89d-01de-4fda-8206-b1be64e5e99a"
              alt="1" width="40" height="40">
          </td>
          <td id="user1" class="item">loading...</td>
          <td id="score1" class="item">loading...</td>
        </tr>
        <tr>
          <td>
            <img
              src="https://firebasestorage.googleapis.com/v0/b/healthcaremanagement-8fa5f.appspot.com/o/images%2Fsecond.png?alt=media&token=fe6eddeb-da8a-43f2-ad6f-8bbe516a1f3f"
              alt="2" width="40" height="40">
          </td>
          <td id="user2" class="item">loading...</td>
          <td id="score2" class="item">loading...</td>
        </tr>
        <tr>
          <td>
            <img
              src="https://firebasestorage.googleapis.com/v0/b/healthcaremanagement-8fa5f.appspot.com/o/images%2Fthird.png?alt=media&token=d787401f-95a5-4810-90dd-28ef2c721190"
              alt="3" width="40" height="40">
          </td>
          <td id="user3" class="item">loading...</td>
          <td id="score3" class="item">loading...</td>
        </tr>
        <tr>
          <td style="font-size: 20px;">4</td>
          <td id="user4" class="item">loading...</td>
          <td id="score4" class="item">loading...</td>
        </tr>
        <tr>
          <td style="font-size: 20px;">5</td>
          <td id="user5" class="item">loading...</td>
          <td id="score5" class="item">loading...</td>
        </tr>
      </table>
    </div>
  </div>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <script>
    function setCookie(name, value, days) {
      var expires = "";
      if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }

    function eraseCookie(name) {
      document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    }

    const username = window.location.href.split("/").pop();

    window.onload = function () {
      socket.emit('score', { un: 'Empty', sc: 0 });
      setCookie('login', username, 3);
    };

    function retry() {
      clearInterval(setIntervalId);
      location.reload();
    }

    function logout() {
      eraseCookie('login');
      window.location.replace("/");
    }

    var socket = io.connect('https://best-record.onrender.com/');
    socket.on('update', function (msg) {
      let data = msg.split(" ");
      let user1 = data[0], score1 = data[1];
      let user2 = data[2], score2 = data[3];
      let user3 = data[4], score3 = data[5];
      let user4 = data[6], score4 = data[7];
      let user5 = data[8], score5 = data[9];
      document.getElementById('user1').innerHTML = user1;
      document.getElementById('user2').innerHTML = user2;
      document.getElementById('user3').innerHTML = user3;
      document.getElementById('user4').innerHTML = user4;
      document.getElementById('user5').innerHTML = user5;
      document.getElementById('score1').innerHTML = score1;
      document.getElementById('score2').innerHTML = score2;
      document.getElementById('score3').innerHTML = score3;
      document.getElementById('score4').innerHTML = score4;
      document.getElementById('score5').innerHTML = score5;

      const items = document.querySelectorAll('.item');
      items.forEach(item => {
        item.style.color = '#ddd';
      });
    });

    const playBoard = document.querySelector(".play-board");
    const scoreElement = document.querySelector(".score");
    const highScoreElement = document.querySelector(".high-score");
    const controls = document.querySelectorAll(".controls i");

    let gameOver = false;
    let foodX, foodY;
    let snakeX = 5, snakeY = 5;
    let velocityX = 0, velocityY = 0;
    let snakeBody = [];
    let setIntervalId;
    let score = 0;

    // Getting high score from the local storage
    let highScore = localStorage.getItem(username) || 0;
    // highScoreElement.innerText = `High Score: ${highScore}`;

    const updateFoodPosition = () => {
      // Passing a random 1 - 30 value as food position
      foodX = Math.floor(Math.random() * 30) + 1;
      foodY = Math.floor(Math.random() * 30) + 1;
    }

    const handleGameOver = () => {
      // Clearing the timer and reloading the page on game over
      clearInterval(setIntervalId);
      // alert("Game Over! Press OK to replay...");
      location.reload();
    }

    const changeDirection = e => {
      // Changing velocity value based on key press
      if (e.key === "ArrowUp" && velocityY != 1) {
        velocityX = 0;
        velocityY = -1;
      } else if (e.key === "ArrowDown" && velocityY != -1) {
        velocityX = 0;
        velocityY = 1;
      } else if (e.key === "ArrowLeft" && velocityX != 1) {
        velocityX = -1;
        velocityY = 0;
      } else if (e.key === "ArrowRight" && velocityX != -1) {
        velocityX = 1;
        velocityY = 0;
      }
    }

    // Calling changeDirection on each key click and passing key dataset value as an object
    controls.forEach(button => button.addEventListener("click", () => changeDirection({ key: button.dataset.key })));

    const initGame = () => {
      if (gameOver) return handleGameOver();
      let html = `<div class="food" style="grid-area: ${foodY} / ${foodX}"></div>`;

      // Checking if the snake hit the food
      if (snakeX === foodX && snakeY === foodY) {
        updateFoodPosition();
        snakeBody.push([foodY, foodX]); // Pushing food position to snake body array
        score++; // increment score by 1
        socket.emit('score', { un: username, sc: score });
        if (score > highScore) {
          highScore = score;
          localStorage.setItem(username, highScore);
        }
        scoreElement.innerText = `Score: ${score}`;
        // highScoreElement.innerText = `High Score: ${highScore}`;
      }
      // Updating the snake's head position based on the current velocity
      snakeX += velocityX;
      snakeY += velocityY;

      // Shifting forward the values of the elements in the snake body by one
      for (let i = snakeBody.length - 1; i > 0; i--) {
        snakeBody[i] = snakeBody[i - 1];
      }
      snakeBody[0] = [snakeX, snakeY]; // Setting first element of snake body to current snake position

      // Checking if the snake's head is out of wall, if so setting gameOver to true
      if (snakeX <= 0 || snakeX > 30 || snakeY <= 0 || snakeY > 30) {
        return gameOver = true;
      }

      for (let i = 0; i < snakeBody.length; i++) {
        // Adding a div for each part of the snake's body
        html += `<div class="head" style="grid-area: ${snakeBody[i][1]} / ${snakeBody[i][0]}"></div>`;
        // Checking if the snake head hit the body, if so set gameOver to true
        if (i !== 0 && snakeBody[0][1] === snakeBody[i][1] && snakeBody[0][0] === snakeBody[i][0]) {
          gameOver = true;
        }
      }
      playBoard.innerHTML = html;
    }

    updateFoodPosition();
    setIntervalId = setInterval(initGame, 100);
    document.addEventListener("keyup", changeDirection);
  </script>
</body>

</html>